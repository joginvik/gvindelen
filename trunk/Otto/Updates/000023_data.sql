SET SQL DIALECT 3;

SET NAMES WIN1251;

SET CLIENTLIB 'fbclient.dll';



INSERT INTO ACTIONCODES (ACTION_SIGN, ACTION_NAME, OBJECT_SIGN, PROCEDURE_NAME)
  VALUES ('ORDERITEM_ANULLED', 'Анулировано немцами', 'ORDERITEM', 'ORDERITEM_STORE');

INSERT INTO ACTIONCODES (ACTION_SIGN, ACTION_NAME, OBJECT_SIGN, PROCEDURE_NAME)
  VALUES ('ORDERTAX_CANCELLED', 'Отменено', 'ORDERTAX', 'ORDERTAX_STORE');

INSERT INTO ACTIONCODES (ACTION_SIGN, ACTION_NAME, OBJECT_SIGN, PROCEDURE_NAME)
  VALUES ('ORDER_ANULLED', 'Анулирован немцами', 'ORDER', 'ORDER_STORE');

INSERT INTO ACTIONCODES (ACTION_SIGN, ACTION_NAME, OBJECT_SIGN, PROCEDURE_NAME)
  VALUES ('ORDER_CANCELLED', 'Анулирован клиентом', 'ORDER', 'ORDER_STORE');



INSERT INTO ACTIONCODE_CRITERIAS (ACTIONCODE_SIGN, PARAM_NAME, PARAM_KIND, PARAM_ACTION, PARAM_VALUE_1, PARAM_VALUE_2)
  VALUES ('ORDER_ANULLED', 'ACTIVEITEMSCOUNT', 'N', '=', '0', NULL);

INSERT INTO ACTIONCODE_CRITERIAS (ACTIONCODE_SIGN, PARAM_NAME, PARAM_KIND, PARAM_ACTION, PARAM_VALUE_1, PARAM_VALUE_2)
  VALUES ('ORDER_CANCELLED', 'ACTIVEITEMSCOUNT', 'N', '=', '0', NULL);



INSERT INTO PARAMKINDS (PARAM_KIND, PARAMKIND_NAME, IS_OUTPUT, ORDER_NO)
  VALUES ('F', 'SQL запрос', 0, 7);



INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDERITEM_ANULLED', 'ID', 'I', NULL);

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDERITEM_ANULLED', 'NEW.STATUS_SIGN', 'V', 'ANULLED');

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDERTAX_CANCELLED', 'ID', 'I', NULL);

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDERTAX_CANCELLED', 'NEW.STATUS_SIGN', 'V', 'CANCELLED');

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDER_ANULLED', 'ACTIVEITEMSCOUNT', 'F', 'select sum(oi.amount) from orderitems oi where oi.order_id = [ID]');

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDER_ANULLED', 'ID', 'I', NULL);

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDER_ANULLED', 'NEW.STATUS_SIGN', 'V', 'ANULLED');

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDER_CANCELLED', 'ACTIVEITEMSCOUNT', 'F', 'select sum(oi.amount) from orderitems oi where oi.order_id = [ID]');

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDER_CANCELLED', 'ID', 'I', NULL);

INSERT INTO ACTIONCODE_PARAMS (ACTION_SIGN, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES ('ORDER_CANCELLED', 'NEW.STATUS_SIGN', 'V', 'CANCELLED');



INSERT INTO ACTIONTREE (ACTIONTREEITEM_ID, ACTION_SIGN, ORDER_NO, CHILD_ACTION)
  VALUES (41, 'ORDERITEM_ANULLED', 1, 'ORDER_ANULLED');

INSERT INTO ACTIONTREE (ACTIONTREEITEM_ID, ACTION_SIGN, ORDER_NO, CHILD_ACTION)
  VALUES (42, 'ORDER_ANULLED', 1, 'ORDER_FOREACH_ORDERTAX');

INSERT INTO ACTIONTREE (ACTIONTREEITEM_ID, ACTION_SIGN, ORDER_NO, CHILD_ACTION)
  VALUES (43, 'ORDER_ANULLED', 2, 'ACCOUNT_DEBITORDER');

INSERT INTO ACTIONTREE (ACTIONTREEITEM_ID, ACTION_SIGN, ORDER_NO, CHILD_ACTION)
  VALUES (51, 'ORDERITEM_CANCEL', 1, 'ORDER_CANCELLED');

INSERT INTO ACTIONTREE (ACTIONTREEITEM_ID, ACTION_SIGN, ORDER_NO, CHILD_ACTION)
  VALUES (52, 'ORDER_CANCELLED', 1, 'ORDER_FOREACH_ORDERTAX');

INSERT INTO ACTIONTREE (ACTIONTREEITEM_ID, ACTION_SIGN, ORDER_NO, CHILD_ACTION)
  VALUES (53, 'ORDER_CANCELLED', 2, 'ACCOUNT_DEBITORDER');



INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (41, 'ID', 'A', 'ORDER_ID');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (42, 'NEW.STATUS_SIGN', 'V', 'CANCELLED');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (42, 'ORDER_ID', 'A', 'ID');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (43, 'AMOUNT_EUR', 'F', 'select coalesce(sum(om.amount_eur), 0) from ordermoneys om where om.order_id = [ID]');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (43, 'ID', 'A', 'ACCOUNT_ID');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (43, 'ORDER_ID', 'A', 'ID');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (51, 'ID', 'A', 'ORDER_ID');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (53, 'AMOUNT_EUR', 'F', 'select coalesce(sum(om.amount_eur), 0) from ordermoneys om where om.order_id = [ID]');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (53, 'ID', 'A', 'ACCOUNT_ID');

INSERT INTO ACTIONTREE_PARAMS (ACTIONTREEITEM_ID, PARAM_NAME, PARAM_KIND, PARAM_VALUE)
  VALUES (53, 'ORDER_ID', 'A', 'ID');




INSERT INTO STATUSES (STATUS_ID, STATUS_NAME, OBJECT_SIGN, IS_DEFAULT, STATUS_SIGN, ACTION_SIGN, FLAG_SIGN_LIST, STORE_DATE)
  VALUES (212, 'Анулировано немцами', 'ORDER', NULL, 'ANULLED', NULL, NULL, 1);



INSERT INTO FLAGS2STATUSES (STATUS_ID, FLAG_SIGN)
  VALUES (161, 'CREDIT');

INSERT INTO FLAGS2STATUSES (STATUS_ID, FLAG_SIGN)
  VALUES (162, 'CREDIT');



INSERT INTO RECODES (OBJECT_SIGN, ATTR_SIGN, ORIGINAL_VALUE, RECODED_VALUE)
  VALUES ('ORDERITEM', 'CANCEL_MESSAGE', 'OK-storniert', 'CANCELLED');

INSERT INTO RECODES (OBJECT_SIGN, ATTR_SIGN, ORIGINAL_VALUE, RECODED_VALUE)
  VALUES ('ORDERITEM', 'CANCEL_MESSAGE', 'canceled', 'ANULLED');

UPDATE RECODES
SET RECODED_VALUE = 'ANULLED'
WHERE (OBJECT_SIGN = 'ORDERITEM') AND (ATTR_SIGN = 'DELIVERY_CODE_TIME') AND (ORIGINAL_VALUE = '5');



UPDATE STATUS_RULES
SET ACTION_SIGN = 'ORDERITEM_ANULLED'
WHERE (OLD_STATUS_ID = 180) AND (NEW_STATUS_ID = 181);

INSERT INTO STATUS_RULES (OLD_STATUS_ID, NEW_STATUS_ID, ACTION_SIGN)
  VALUES (184, 181, 'ORDERITEM_ANULLED');

INSERT INTO STATUS_RULES (OLD_STATUS_ID, NEW_STATUS_ID, ACTION_SIGN)
  VALUES (205, 212, 'ORDER_ANULLED');

INSERT INTO STATUS_RULES (OLD_STATUS_ID, NEW_STATUS_ID, ACTION_SIGN)
  VALUES (207, 212, 'ORDER_ANULLED');



update orderitems
set amount = amount;